import { existsSync } from "fs";
import { getApiKey, getApiUrl, getConfigPath, isCustomApiUrl, } from "../lib/config.js";
import { getUserInfo } from "../lib/api.js";
import * as output from "../lib/output.js";
export async function whoamiCommand() {
    const apiKey = getApiKey();
    const apiUrl = getApiUrl();
    const configPath = getConfigPath();
    if (!apiKey) {
        output.error("Not authenticated. Run `bankr login` to set up your Bankr API key.");
        process.exit(1);
    }
    const source = process.env.BANKR_API_KEY ? "env (BANKR_API_KEY)" : configPath;
    output.label("Bankr API Key", output.maskApiKey(apiKey));
    output.label("Bankr API URL", apiUrl);
    if (isCustomApiUrl()) {
        output.warn("Using a non-official Bankr API URL");
    }
    output.label("Source", source);
    if (existsSync(configPath)) {
        output.label("Config", configPath);
    }
    console.log();
    const spin = output.spinner("Checking Bankr API connection...");
    try {
        const res = await fetch(`${apiUrl}/_health`, {
            headers: { "X-API-Key": apiKey },
        });
        if (res.ok) {
            spin.succeed("Bankr API connection OK");
        }
        else {
            spin.fail(`Bankr API returned ${res.status}`);
            return;
        }
    }
    catch (err) {
        spin.fail(`Could not reach Bankr API: ${err.message}`);
        return;
    }
    // Fetch user profile info
    const profileSpin = output.spinner("Fetching account info...");
    try {
        const info = await getUserInfo();
        profileSpin.succeed("Account info loaded");
        console.log();
        output.label("Wallets", "");
        for (const w of info.wallets) {
            console.log(`  ${w.chain.toUpperCase().padEnd(8)} ${w.address}`);
        }
        if (info.socialAccounts.length > 0) {
            console.log();
            output.label("Social Accounts", "");
            for (const s of info.socialAccounts) {
                const displayPlatform = s.platform === "twitter" ? "x (twitter)" : s.platform;
                console.log(`  ${displayPlatform.padEnd(12)} ${s.username ?? output.fmt.dim("(no username)")}`);
            }
        }
        console.log();
        const clubStatus = info.bankrClub.active
            ? `Active (${info.bankrClub.subscriptionType ?? "unknown"})`
            : "Inactive";
        output.label("Bankr Club", clubStatus);
        if (info.refCode) {
            output.label("Referral Code", info.refCode);
        }
        const { score, rank } = info.leaderboard;
        const rankStr = rank ? ` (#${rank})` : "";
        output.label("Score", `${score}${rankStr}`);
    }
    catch (err) {
        profileSpin.fail(`Could not fetch account info: ${err.message}`);
    }
}
//# sourceMappingURL=whoami.js.map